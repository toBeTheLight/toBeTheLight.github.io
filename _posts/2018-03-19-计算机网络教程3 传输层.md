---
layout: post
title:  "阅读：计算机网络教程（3）传输层"
categories: 阅读笔记 计算机网络
tags:  计算机网络 端口
author: toBeTheLight
---

* content
{:toc}

此章切换英文版  

* 基本介绍
    * TCP/IP协议簇中的传输层位于应用层和网络层中间，接受网络层的服务，并向应用层提供服务。
    * 是TCP/IP协议簇中的核心。
    * 是因特网上从一个点到另一个点传输数据的端到端的逻辑传输媒介。




# 3.1 介绍和传输层服务

传输层协议提供运行在两个主机应用进程间的**逻辑连接**。

发送方传输层将从应用进程接收到的接收到的报文转换为段（segment），会在每个段中加入传输层header。然后会将段发送至网络层，在这里会被装进网络层数据报。网络路由器仅对数据报的网络层字段起作用。接收方，网络层从数据报中提取段，然后传给传输层，传输层处理接收到的段，使段中数据可用于接收端应用。

## 3.1.1 传输层和网络层的关系

* 传输层提供运行在不同主机的进程的逻辑连接，网络层协议提供主机间的逻辑连接。

* 传输层提供的服务经常受到底层限制，比如，如果网络层协议不能保证主机间发送的传输层数据段的延迟和带宽，那么传输层协议就不能保证进程间传输的应用报文的延迟和带宽。

* 在底层网络层协议不能提供对应服务时，传输也能提供某些服务。如网络层协议不可靠时，传输层也能向应用提供可靠的数据传输服务；网络层不保证传输层数据段的机密性时，传输层也能通过使用加密使实习无法被入侵者读取。

## 3.1.2 传输层概述

* TCP/IP网络为应用层提供了两种不同的传输层协议，TCP/UDP。

    * UDP（User Datagram Protocol）：不可靠，无状态。
    * TCP（Transmission Control Protocol）：可靠，面向连接的服务。

* 我们将传输层数据包(packet)称为段（segment），有时我们也将TCP的分组数据包称为段，而将UDP的称为数据报文（datagram）。

* UDP和TCP的基本职责是将终端间的传输服务扩展为终端进程间的传输服务。称为多路复用和多路分解。

* TCP和UDP还通过分段头中包含的检测字段来进行完整性检查.
    * UDP只提供进程间的数据传输和错误检查服务，与IP服务一样是不可靠的。
    * TCP向应用提供其他服务，TCP是可靠的数据传输服务，使用流控制（flow control）、序列号（sequence number）、确认（acknowledgments）、定时器（timers）可以保证数据正确有序的传输。可将主机间不可靠的IP服务转变为进程间可靠地数据传输服务。
        * 拥塞控制：防止过量通信淹没链路和路由器。
        * 通过调整发送端可发送的速率来力争通过拥塞链路的每个连接均分链路带宽。
位于网络层和应用层直接，负责向应用层提供服务，接收来自网络层的服务。

# 3.2 多路复用和多路分解

传输层有将段中数据传输给合适的进程的职责。一个进程可以有多个socket，socket是数据在进程和网络间的转换和传递的通道，每个socket都有独特的识别码（IP+Port）。

* 在接收端，每个传输层分段都有一组字段，传输层检测这些字段去识别接收的socket，并将这些分段引导到socket，称为多路分解。
* 收集来自不同的socket的数据块，添加头信息并封装为分段，将分段传递给网络层叫多路复用。

多路复用和多路分解条件：
1. socket有独特的识别码
2. 每个数据段有特殊字段标识此段的目标socket
    * 来源端口字段
    * 目的端口字段

### 端口号

实现进程到进程通信，最常用的是通过客户-服务器模式（client-server paradigm）。客户和服务器（两个进程）有相同的名字，如要从服务器上获取时间，需要在本地主机和远程服务器上运行Daytime服务。

由于计算机可以在同一时间运行多个服务器程序，我们必须定义本地主机、本地进程、远程主机和远程进程。我们使用IP地址定义主机，使用端口号（port number）定义进程。在TCP/IP协议簇中，端口号是在0到65535之间的16位整数。
* 客户程序用临时端口号（ephemeral port number）定义自己，推荐值大于1023。
* 服务器进程一般使用固定端口号，在TCP/IP决定使用全局端口号，经常使用也称为熟知端口号。
* IP地址在世界范围内确定一个主机，端口号定义了在该特定主机上的一个服务。

### 不面向连接的多路复用和多路分解

以UDP为例子，使用二元信息（ip+端口号）来标识UDP socket。来源ip+端口号不同，但具有相同目的ip+端口号的UDP数据段会被通过同一个socket发送到相同的进程。

### 面向连接的多路复用和多路分解

以TCP为例子，使用四元信息来标识，源IP/源端口号和目的IP/目的端口号。不同源标识但是有相同目的标识的数据段（除了携带原始连接建立请求的TCP段）会被引导到不同的socket.

1. 服务进程有一个等待连接的welcome socket，三次握手是与welcome socket之间。
2. 客户端创建针对某个端口号的连接建立数据段。
3. 连接建立请求只有一个带有目标端口号和极少的特殊连接建立TCP头信息的TCP段。
4. 服务器系统接收到带有这个目的端口的连接请求段，找到此端口的等待连接的服务进程，然后服务器进程创建一个新的socket。
5. 同时，服务端传输层记录下四元信息（源IP/源端口、目的IP/目的端口），新创建的socket使用四元信息标识。随后所有匹配这四元信息的段被解复用到这个socket。

### Web服务器和TCP

Web服务器为每个连接创建一个新的进程，这些进程都有自己的连接socket。但是事实上，连接socket和进程间并不是一一对应的，现在的高性能Web服务器只用一个进程，而对每个客户端连接创建一个带有连接socket的新线程。

非持久HTTP连接会有频繁的创建过程，会严重影响Web服务的性能。

# 3.3 无状态传输：UDP

* UDP只做这些工作：

    * 从应用进程获得报文，为多路复用/多路解复用添加源和目的端口号字段
    * 添加两个别的小字段
    * 将处理过的数据段发给网络层

    因为不存在握手建立连接的过程，所以UDP又被叫做无连接的。

* DNS典型的应用UDP的例子：
    * 构建DNS查询报文，并传送给UDP
    * 不与目标端系统UDP实例握手的情况下，UDP向报文添加头字段，并将结果段数据传送给网络层
    * 网络层封装UDP段数据为数据报，并发送给域名服务
    * 主机的DNS应用等待他的查询回复，如果没有收到回复，那么向另一个域名服务重复上述步骤，或通知应用没有收到回复

* UDP的优势与适用：
    * 更好的应用级别的控制发送什么数据，什么时候发送数据：TCP的可靠性和拥塞控制机制会带来延迟等问题。低速率、能容忍数据丢失、需要低延迟的数据发送的及时应用就需要使用UDP作为应用的一部分。
    * 不建立连接：没有握手过程会更快。
    * 没有连接状态：服务可以支持更多的客户端。
    * 更小的数据包头信息开销：每个数据段UDP只有8字节的开销，而TCP有20字节。

* 需求低延迟并能容忍丢包的应用会选择UDP，如多媒体应用。当丢包降低，出于安全原因，一些组织组织UDP流量，TCP成为越来越受流媒体传输欢迎的协议。

* UDP没有拥塞控制机制可能导致数据溢出路由器，从而导致大量数据丢失，甚至显著影响TCP的速率。同时虽然UDP是不可靠的，但是我们可以在应用中自己实现使UDP变得可靠，并且不用限制在TCP拥塞机制强加的速率限制下。

## 3.3.1 UDP段结构

| 源端口 # | 目的端口 #|
|:---:|:---:|
| 长度 |校验|
| 报 | 文 |

* 报文部分包含查询信息和返回信息
* header有只有4个字段，每个字段有2个字节
* 接收方用校验部分插件段中是否被加入了错误数据

## 3.3.2 UDP校验

检验过程：

* 发送方将段中所有16位的字的总和的补码添加到UDP段的校验字段中。如0110011001100000、0101010101010101、1000111100001100求得和为0100101011000010，补码为1011010100111101作为校验字段的值。
* 接收方将所有16位的字的总和和校验字段的值相加，如果不是111111111111，有1位是0则水命数据有误。

由于低层协议会发生错误，并且并不是百分百的提供错误校验机制，同时某些功能在低层提供成本高或价值不大，所以这些功能需要在端到端（传输层是端到端的基础）提供。

虽然UDP有错误校验机制，但是它并不会主动修复错误，一般是丢弃段，或者将损坏数据带有警告的发送给应用，所以它还是不可靠的。